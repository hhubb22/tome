<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="åŸºäºEPUBè½¬æ¢çš„ç°ä»£åŒ–ç”µå­ä¹¦é˜…è¯»å™¨">
    <meta name="author" content="Tome EPUB Reader">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ styles_path }}">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“–</text></svg>">
</head>
<body>
    <!-- é˜…è¯»è¿›åº¦æ¡ -->
    <div class="reading-progress" id="reading-progress"></div>
    
    <main class="content">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <header class="header">
            <button class="theme-toggle" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢æ˜æš—ä¸»é¢˜">
                ğŸŒ™
            </button>
            <h1>{{ title }}</h1>
            <div class="subtitle">äº«å—æ²‰æµ¸å¼é˜…è¯»ä½“éªŒ</div>
        </header>
        
        <!-- æ–‡ç« å†…å®¹ -->
        <article>
            {{ body }}
        </article>
        
        <!-- é¡µé¢å¯¼èˆª -->
        <nav class="page-nav" role="navigation" aria-label="é¡µé¢å¯¼èˆª">
            {{ nav }}
        </nav>
    </main>
    
    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" id="back-to-top" aria-label="è¿”å›é¡¶éƒ¨" title="è¿”å›é¡µé¢é¡¶éƒ¨">
        â†‘
    </button>

    <script>
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        (function() {
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            
            // è·å–ä¿å­˜çš„ä¸»é¢˜æˆ–æ ¹æ®ç³»ç»Ÿåå¥½è®¾ç½®é»˜è®¤ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (systemDark ? 'dark' : 'light');
            
            // åº”ç”¨åˆå§‹ä¸»é¢˜
            html.setAttribute('data-theme', initialTheme);
            updateThemeIcon(initialTheme);
            
            // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                // æ·»åŠ åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
                themeToggle.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    themeToggle.style.transform = 'scale(1)';
                }, 150);
            });
            
            function updateThemeIcon(theme) {
                themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
                themeToggle.title = theme === 'dark' ? 'åˆ‡æ¢åˆ°æ˜äº®ä¸»é¢˜' : 'åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜';
            }
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    html.setAttribute('data-theme', newTheme);
                    updateThemeIcon(newTheme);
                }
            });
        })();

        // é˜…è¯»è¿›åº¦æ¡åŠŸèƒ½
        (function() {
            const progressBar = document.getElementById('reading-progress');
            const article = document.querySelector('article');
            
            if (!article) return;
            
            function updateProgress() {
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const viewportHeight = window.innerHeight;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                const totalScrollableHeight = articleHeight - viewportHeight + articleTop;
                const scrolled = Math.max(0, scrollTop - articleTop);
                const progress = Math.min(100, (scrolled / totalScrollableHeight) * 100);
                
                progressBar.style.transform = `scaleX(${progress / 100})`;
            }
            
            // èŠ‚æµå‡½æ•°
            function throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }
            
            window.addEventListener('scroll', throttle(updateProgress, 10));
            window.addEventListener('resize', throttle(updateProgress, 100));
            updateProgress(); // åˆå§‹åŒ–è¿›åº¦
        })();

        // è¿”å›é¡¶éƒ¨æŒ‰é’®åŠŸèƒ½
        (function() {
            const backToTop = document.getElementById('back-to-top');
            
            function toggleBackToTopButton() {
                if (window.pageYOffset > 300) {
                    backToTop.classList.add('visible');
                } else {
                    backToTop.classList.remove('visible');
                }
            }
            
            backToTop.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            window.addEventListener('scroll', function() {
                requestAnimationFrame(toggleBackToTopButton);
            });
        })();

        // å›¾ç‰‡æ‡’åŠ è½½å’Œç‚¹å‡»æ”¾å¤§åŠŸèƒ½
        (function() {
            const images = document.querySelectorAll('img');
            
            images.forEach(img => {
                // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                });
                
                // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ï¼ˆç®€å•å®ç°ï¼‰
                img.addEventListener('click', function() {
                    if (this.style.transform === 'scale(1.5)') {
                        this.style.transform = 'scale(1)';
                        this.style.cursor = 'zoom-in';
                        this.style.zIndex = 'auto';
                    } else {
                        this.style.transform = 'scale(1.5)';
                        this.style.cursor = 'zoom-out';
                        this.style.zIndex = '10';
                    }
                });
                
                img.style.cursor = 'zoom-in';
            });
        })();

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        (function() {
            document.addEventListener('keydown', function(e) {
                // Alt + T: åˆ‡æ¢ä¸»é¢˜
                if (e.altKey && e.key.toLowerCase() === 't') {
                    e.preventDefault();
                    document.getElementById('theme-toggle').click();
                }
                
                // ç©ºæ ¼é”®: å‘ä¸‹æ»šåŠ¨
                if (e.key === ' ' && !e.target.matches('input, textarea, [contenteditable]')) {
                    e.preventDefault();
                    window.scrollBy({
                        top: window.innerHeight * 0.8,
                        behavior: 'smooth'
                    });
                }
                
                // Shift + ç©ºæ ¼é”®: å‘ä¸Šæ»šåŠ¨
                if (e.key === ' ' && e.shiftKey) {
                    e.preventDefault();
                    window.scrollBy({
                        top: -window.innerHeight * 0.8,
                        behavior: 'smooth'
                    });
                }
                
                // Home: å›åˆ°é¡¶éƒ¨
                if (e.key === 'Home' && e.ctrlKey) {
                    e.preventDefault();
                    document.getElementById('back-to-top').click();
                }
            });
        })();

        // æ€§èƒ½ä¼˜åŒ–ï¼šé¢„åŠ è½½ä¸‹ä¸€é¡µ
        (function() {
            const nextLink = document.querySelector('.nav-next');
            if (nextLink && 'IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // é¢„åŠ è½½ä¸‹ä¸€é¡µ
                            const link = document.createElement('link');
                            link.rel = 'prefetch';
                            link.href = nextLink.href;
                            document.head.appendChild(link);
                            observer.disconnect();
                        }
                    });
                });
                
                observer.observe(document.querySelector('.page-nav'));
            }
        })();
    </script>
</body>
</html>